<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>System Config</title>
</head>

<body style="font-family: monospace;">
    <h1 id="sysInfo">System Information</h1>
    <table id="sysInfo_ex" hidden>
        <thead>
            <tr>
                <th scope="col">Item</th>
                <th scope="col">:</th>
                <th scope="col">Value</th>
            </tr>
        </thead>
        <tbody id="sysInfo_exBody"></tbody>
    </table>

    <h1 id="ops">Operations</h1>
    <ul id="ops_ex" hidden>
        <li><a href="/update">Update firmware</a></li>
        <li><button id="restartBtn">Restart Device</button></li>
        <li><button id="sleepBtn">Deep Sleep</button></li>
    </ul>

    <h1 id="cfg">Config</h1>
    <table id="cfg_ex" hidden>
        <form id="cfgForm"><button type="submit">Submit changes</button></form>
        <p id="cfgRes"></p>
        <thead>
            <th>Key</th>
            <th>Value</th>
        </thead>
        <tbody id="cfg_exBody"></tbody>
    </table>
</body>

<script>
    function _(el) {
        return document.getElementById(el);
    };

    _('sysInfo').addEventListener("click", () => {
        fetch('/systemInfo').then(res => res.json()).then(data => {
            const infoBody = document.createDocumentFragment();
            for (const key in data) {
                const infoBodyLn = infoBody.appendChild(document.createElement("tr"));
                infoBodyLn.appendChild(document.createElement("td")).textContent = key;
                infoBodyLn.appendChild(document.createElement("td")).textContent = ':';
                infoBodyLn.appendChild(document.createElement("td")).textContent = data[key];
            }
            _('sysInfo_exBody').replaceChildren(infoBody);
        });
        _('sysInfo_ex').hidden = !_('sysInfo_ex').hidden;
    });

    _('ops').onclick = function () {
        _('ops_ex').hidden = !_('ops_ex').hidden;
    };

    _('restartBtn').addEventListener("click", () => {
        const url = new URL('/device', window.location.origin);
        url.searchParams.append('action', 'restart');
        fetch(url);
    });

    _('cfg').addEventListener("click", () => {
        fetch('/userCfg.json').then(res => res.json()).then(data => {
            const cfgBody = document.createDocumentFragment();
            for (const key in data) {
                const cfgBodyLn = cfgBody.appendChild(document.createElement("tr"));
                cfgBodyLn.appendChild(document.createElement("td")).textContent = key;
                const cfgBodyLnCell = cfgBodyLn.appendChild(document.createElement("td"));
                const cfgBodyLnInput = cfgBodyLnCell.appendChild(document.createElement("input"));
                cfgBodyLnInput.value = data[key];
                cfgBodyLnInput.type = 'text';
                cfgBodyLnInput.setAttribute('form', 'cfgForm');
                cfgBodyLnInput.setAttribute('name', key);
            }
            _('cfg_exBody').replaceChildren(cfgBody);
        });
        _('cfg_ex').hidden = !_('cfg_ex').hidden;
    });

    _('cfgForm').addEventListener("submit", (e) => {
        e.preventDefault();
        const formdata = new FormData(_('cfgForm'));
        formdata.forEach(data => console.log(data));
        console.log(JSON.stringify(Object.fromEntries(formdata)));
        fetch('/modCfg', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', },
            body: JSON.stringify(Object.fromEntries(formdata)),
        }).then(res => res.json()).then(data => {
            _('cfgRes').textContent = data['text'];
            window.open(data['file']);
        });
    });
</script>

</html>